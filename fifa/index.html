<!--
README - Metro Derby 3D (Original, single-file Three.js soccer prototype)
Run:
1) Recommended local server:
   python -m http.server 8080
2) Open:
   http://localhost:8080/Code/fifa/index.html
Direct file open can work, but local server is safer for module/CORS behavior.

Default Controls:
WASD move | Shift sprint | Left Click/J pass | E through | Q lob
Right Click/K shoot (hold/release) | F finesse | X chip | H tutorial
Space tackle | C slide | Tab switch | Esc pause
F3 debug overlay | V camera | P pointer lock | F4 dev panel
R reset ball (debug only) | T slow motion
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metro Derby 3D</title>
<style>
:root{--bg:#0d1e14;--panel:rgba(6,14,10,.82);--bd:rgba(160,255,190,.28);--txt:#e9ffe8;--muted:#b6d2bb;--a:#ff6b35;--b:#2f86ff;--acc:#ffe169}
body.cb{--a:#ffb703;--b:#219ebc;--acc:#d8f339}
*{box-sizing:border-box}html,body{margin:0;width:100%;height:100%;overflow:hidden;background:radial-gradient(120% 90% at 20% 0,#1f4a31 0,transparent 62%),linear-gradient(130deg,#0a1a11,#0f2c1e);color:var(--txt);font-family:Trebuchet MS,Segoe UI,Tahoma,sans-serif}
#app{position:relative;width:100%;height:100%}#c{display:block;width:100%;height:100%}
#overlay{position:absolute;inset:0;pointer-events:none;display:grid;grid-template-rows:auto 1fr auto;transform-origin:top left}
.top,.bot{padding:10px;display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
.mid{display:flex;justify-content:center;align-items:center}
.chip,.score,.card,#mapWrap,#debug,#dev,#notice,#ptr{background:var(--panel);border:1px solid var(--bd);box-shadow:0 8px 18px rgba(0,0,0,.35);border-radius:10px}
.chip{padding:6px 9px;font-size:12px;color:var(--muted)}.chip b{color:var(--acc)}
.chipBtn{pointer-events:auto;padding:6px 10px;font-size:12px;border-radius:10px;border:1px solid var(--bd);background:var(--panel);color:var(--txt);cursor:pointer;line-height:1.2}
.score{display:grid;grid-template-columns:1fr auto 1fr;min-width:360px;padding:8px 12px;gap:12px;text-align:center;pointer-events:auto}
.team{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.team.a{color:var(--a)}.team.b{color:var(--b)}
.sc{font-size:28px;font-weight:800;line-height:1}.clk{font-size:12px;color:var(--muted)}
.card{padding:8px 10px;max-width:320px;pointer-events:auto}.line{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
.bar{height:8px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.22)}.fill{height:100%;width:100%;background:linear-gradient(90deg,#5af6a5,#ffe06f)}
#mapWrap{padding:7px;pointer-events:auto}#map{display:block;width:220px;height:140px;border-radius:7px;border:1px solid rgba(255,255,255,.2);background:#102519}
#shot{position:absolute;bottom:96px;width:240px;height:12px;border-radius:999px;background:rgba(255,255,255,.13);border:1px solid rgba(255,255,255,.22);opacity:0;transition:opacity .12s;overflow:hidden}
#shot.on{opacity:1}#shot>div{height:100%;width:0;background:linear-gradient(90deg,#79ffb5,#ffda67,#ff5f5f)}
#notice{position:absolute;left:50%;top:84px;transform:translateX(-50%);padding:6px 10px;font-size:12px;color:var(--acc);opacity:0;transition:opacity .2s;z-index:8}
#notice.on{opacity:1}
#debug{position:absolute;right:10px;top:10px;white-space:pre;display:none;padding:8px 10px;font:12px/1.35 Consolas,monospace;z-index:15}
#dev{position:absolute;left:10px;top:10px;display:none;padding:8px;width:300px;max-height:62vh;overflow:auto;pointer-events:auto;z-index:15;font-size:12px}
.dev{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;margin:6px 0}.dev .v{width:54px;text-align:right;color:var(--acc)}
#ptr{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);font-size:11px;padding:4px 8px}
#menu,#pause,#tutorial{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;pointer-events:auto}
#menu{background:radial-gradient(ellipse at center,rgba(10,27,18,.7),rgba(6,12,9,.94));z-index:20}
#pause,#tutorial{display:none;background:rgba(6,13,9,.74);z-index:25}
.scr{width:min(720px,calc(100vw - 28px));max-height:calc(100vh - 28px);overflow:auto;padding:14px;border-radius:12px;border:1px solid var(--bd);background:linear-gradient(180deg,rgba(11,24,16,.97),rgba(8,17,12,.95));box-shadow:0 12px 24px rgba(0,0,0,.35);display:none}
.scr.on{display:block}.ttl{margin:0 0 8px;font-size:28px;display:flex;align-items:center;gap:8px}.sub{margin:0 0 12px;color:var(--muted);font-size:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}.row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px}
.row:last-child{border-bottom:0}
button,select,input{pointer-events:auto}button{border:1px solid rgba(150,255,176,.35);background:linear-gradient(180deg,rgba(23,48,34,.92),rgba(11,23,16,.94));color:var(--txt);padding:10px;border-radius:9px;font-weight:700;cursor:pointer}button.p{border-color:rgba(255,221,90,.7)}
select{background:#08140d;color:var(--txt);border:1px solid rgba(139,255,180,.28);border-radius:7px;padding:5px 8px}
#ctrl{display:grid;gap:6px}.ci{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px 8px;background:rgba(2,9,6,.6);font-size:13px}.ci .n{color:var(--muted)}.bind{min-width:130px;padding:5px 8px;border-radius:8px;border:1px solid rgba(139,255,180,.28);background:#0b1a12;text-align:center;font-size:12px}.bind.wait{border-color:rgba(255,214,90,.75);color:#fff2bb}
#vfx{position:absolute;inset:0;pointer-events:none;z-index:6;opacity:0;transition:opacity .15s;background:radial-gradient(120% 100% at 50% 50%,transparent 55%,rgba(0,0,0,.25) 100%),repeating-linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.02) 1px,transparent 1px,transparent 3px)}
body.fx #vfx{opacity:.45}body.rm *{transition:none!important;animation:none!important}
</style>
</head>
<body>
<div id="app">
  <canvas id="c"></canvas><div id="vfx"></div>
  <div id="overlay">
    <div class="top">
      <div style="display:flex;gap:8px"><div class="chip">Possession: <b id="pos">-</b></div><div class="chip">Phase: <b id="phase">-</b></div></div>
      <div class="score"><div><div id="tA" class="team a">Metro Foxes</div></div><div><div class="sc"><span id="sA">0</span> - <span id="sB">0</span></div><div id="clk" class="clk">00:00 | 1H</div></div><div><div id="tB" class="team b">Harbor Comets</div></div></div>
      <div style="display:flex;gap:8px"><div class="chip">Mode: <b id="mode">menu</b></div><div class="chip">Replay: <b id="rpl">Idle</b></div><button id="openTut" class="chipBtn">Tutorial (H)</button></div>
    </div>
    <div class="mid"><div id="shot"><div id="shotFill"></div></div></div>
    <div class="bot">
      <div class="card"><div class="line"><span>Selected</span><b id="sel">-</b></div><div class="line"><span>Stamina</span><span id="stamTxt">100%</span></div><div class="bar"><div id="stam" class="fill"></div></div></div>
      <div id="mapWrap"><canvas id="map" width="220" height="140"></canvas></div>
    </div>
  </div>
  <div id="notice">Kickoff</div><div id="debug"></div><div id="dev"></div><div id="ptr">Pointer: Off</div>

  <div id="tutorial"><div class="scr on"><h3 style="margin-top:0">Quick Tutorial</h3><p class="sub">Use <b>W</b> to move toward the top of your screen. Press <b>H</b> anytime to reopen this panel.</p><div class="grid"><div class="card"><div style="font-weight:700;margin-bottom:6px">Move & Camera</div><ul style="margin:0;padding-left:18px"><li>WASD move</li><li>Shift sprint (drains stamina)</li><li>V switch camera</li><li>P pointer lock</li></ul></div><div class="card"><div style="font-weight:700;margin-bottom:6px">Ball Actions</div><ul style="margin:0;padding-left:18px"><li>Pass: Left Click / J</li><li>Through: E</li><li>Lob: Q</li><li>Shoot hold/release: Right Click / K</li><li>F finesse, X chip</li></ul></div><div class="card"><div style="font-weight:700;margin-bottom:6px">Defense & Utility</div><ul style="margin:0;padding-left:18px"><li>Space standing tackle</li><li>C slide tackle</li><li>Tab switch player</li><li>Esc pause</li><li>F3 debug, F4 dev panel</li></ul></div></div><div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="closeTut" class="p">Resume</button></div></div></div>

  <div id="menu">
    <div id="main" class="scr on"><h1 class="ttl"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.8"/><path d="M12 6l2 2-1 3h-2l-1-3 2-2zM8 11l2-1 2 1 2-1 2 1v3l-2 1-2-1-2 1-2-1v-3zM9 16l3 2 3-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>Metro Derby 3D</h1><p class="sub">Original arcade-sim soccer prototype.</p><div class="grid"><button class="p" data-start="match">Start Match</button><button data-start="training">Training Mode</button><button data-open="setup">Match Setup</button><button data-open="settings">Settings</button><button data-open="controls">Controls</button><button data-open="access">Accessibility</button></div></div>
    <div id="setup" class="scr"><h2 class="ttl">Match Setup</h2><div class="row"><label>Difficulty</label><select id="difficulty"><option value="beginner">Beginner</option><option value="normal">Normal</option><option value="pro">Pro</option></select></div><div class="row"><label>Half Length (minutes)</label><select id="half"><option>2</option><option>3</option><option selected>4</option><option>6</option></select></div><div class="row"><label>Fouls (lite)</label><input id="fouls" type="checkbox" checked></div><div class="row"><label>Offside (simple)</label><input id="offside" type="checkbox"></div><div class="row"><label>PostFX</label><input id="postfx" type="checkbox"></div><div class="grid" style="margin-top:10px"><button class="p" data-start="match">Start Match</button><button data-open="main">Back</button></div></div>
    <div id="settings" class="scr"><h2 class="ttl">Settings</h2><div class="row"><label>Camera</label><select id="camMode"><option value="broadcast">Broadcast</option><option value="chase">Chase</option></select></div><div class="row"><label>Pass Assist</label><input id="assistPass" type="checkbox" checked></div><div class="row"><label>Shot Assist</label><input id="assistShot" type="checkbox" checked></div><div class="row"><label>Pointer Lock Preferred</label><input id="ptrPref" type="checkbox"></div><div class="row"><label>Quality</label><select id="quality"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div><div class="row"><label>Master Volume</label><input id="volM" type="range" min="0" max="1" step="0.01"></div><div class="row"><label>Music Volume</label><input id="volMu" type="range" min="0" max="1" step="0.01"></div><div class="row"><label>SFX Volume</label><input id="volS" type="range" min="0" max="1" step="0.01"></div><div class="grid" style="margin-top:10px"><button data-open="main">Back</button></div></div>
    <div id="controls" class="scr"><h2 class="ttl">Controls</h2><p class="sub">Click binding to remap. Saved in localStorage.</p><div id="ctrl"></div><div class="grid" style="margin-top:10px"><button id="resetBind">Reset Defaults</button><button data-open="main">Back</button></div></div>
    <div id="access" class="scr"><h2 class="ttl"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="5" r="2.2" stroke="currentColor" stroke-width="1.5"/><path d="M4 10h16M12 7v12M8 22l4-6 4 6M6 18l3-4M18 18l-3-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Accessibility</h2><div class="row"><label>Color-blind palette</label><input id="cb" type="checkbox"></div><div class="row"><label>Reduce motion</label><input id="rm" type="checkbox"></div><div class="row"><label>HUD scale</label><select id="hud"><option value="0.9">Small</option><option value="1">Default</option><option value="1.15">Large</option></select></div><div class="grid" style="margin-top:10px"><button data-open="main">Back</button></div></div>
  </div>

  <div id="pause"><div class="scr on" style="width:min(420px,calc(100vw - 20px))"><h2 style="margin-top:0">Paused</h2><div class="grid"><button id="resume" class="p">Resume</button><button id="restart">Restart Match</button><button data-open-pause="settings">Settings</button><button id="quit">Quit to Menu</button></div></div></div>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.166.1/build/three.module.js";

const SEED=20260222, FIX=1/60, MAX_ACC=.2, MAX_STEPS=6;
const PITCH_L=105, PITCH_W=68, GOAL_W=7.32, GOAL_H=2.44, BALL_R=.22, P_R=.55, TEAM_N=11, TOTAL=22;
const STORE={s:"metro_derby_settings_v1",b:"metro_derby_bindings_v1",f:"metro_derby_first_run_v1"};
const FORM=[[-48,0,"GK"],[-33.5,24,"DEF"],[-36,8,"DEF"],[-36,-8,"DEF"],[-33.5,-24,"DEF"],[-17.5,15.5,"MID"],[-18.5,0,"MID"],[-17.5,-15.5,"MID"],[2.5,24,"FWD"],[8,0,"FWD"],[2.5,-24,"FWD"]];
const DIFF={beginner:{reaction:.36,passError:.26,shotError:.30,press:.55,keeper:.62},normal:{reaction:.24,passError:.18,shotError:.20,press:.76,keeper:.78},pro:{reaction:.14,passError:.10,shotError:.12,press:.92,keeper:.90}};
const DEF_SET={difficulty:"normal",halfLengthMin:4,cameraMode:"broadcast",assistPass:true,assistShot:true,pointerLockPreferred:false,masterVolume:.82,musicVolume:.30,sfxVolume:.84,colorBlind:false,reduceMotion:false,hudScale:1,fouls:true,offside:false,quality:"high",debugOverlay:false,postFx:false,trainingMode:false};
const ACT={moveUp:"Move Up",moveDown:"Move Down",moveLeft:"Move Left",moveRight:"Move Right",sprint:"Sprint",pass:"Pass (Ground)",through:"Through Ball",lob:"Lob Pass",shoot:"Shoot",finesse:"Finesse Modifier",chip:"Chip Modifier",tackle:"Tackle",slide:"Slide Tackle",switchPlayer:"Switch Player",pause:"Pause",toggleTutorial:"Tutorial",toggleDebug:"Toggle Debug",toggleCamera:"Toggle Camera",pointerLock:"Pointer Lock",toggleDevPanel:"Dev Panel",slowMo:"Slow Motion",resetBall:"Reset Ball (Debug)"};
const AORDER=Object.keys(ACT);
const DEF_BIND={moveUp:["KeyW"],moveDown:["KeyS"],moveLeft:["KeyA"],moveRight:["KeyD"],sprint:["ShiftLeft","ShiftRight"],pass:["Mouse0","KeyJ"],through:["KeyE"],lob:["KeyQ"],shoot:["Mouse2","KeyK"],finesse:["KeyF"],chip:["KeyX"],tackle:["Space"],slide:["KeyC"],switchPlayer:["Tab"],pause:["Escape"],toggleTutorial:["KeyH"],toggleDebug:["F3"],toggleCamera:["KeyV"],pointerLock:["KeyP"],toggleDevPanel:["F4"],slowMo:["KeyT"],resetBall:["KeyR"]};
const TUNE={playerMaxSpeed:7.4,sprintMultiplier:1.34,playerAccel:22,turnRate:8.5,staminaDrain:.20,staminaRegen:.12,passPower:23,throughPower:25,lobPower:19,shotPower:36,shotLift:4.8,chipLift:7.6,dribbleSpring:25,dribbleDamping:8.2,ballBounce:.62,ballFriction:.985,ballAirDrag:.08,magnus:.0022,aiPress:.75};
const clamp=(v,l,h)=>v<l?l:v>h?h:v, mix=(a,b,t)=>a+(b-a)*t, sat=v=>clamp(v,0,1);
const wAng=a=>{let x=a;while(x>Math.PI)x-=Math.PI*2;while(x<-Math.PI)x+=Math.PI*2;return x};
const jParse=(s,f)=>{try{return JSON.parse(s)}catch{return f}};
class RNG{constructor(seed){this.s=seed>>>0}next(){let x=this.s;x^=x<<13;x^=x>>>17;x^=x<<5;this.s=x>>>0;return(this.s&0xffffffff)/0x100000000}r(a,b){return a+(b-a)*this.next()}i(a,b){return Math.floor(this.r(a,b+1))}c(arr){return arr[Math.floor(this.next()*arr.length)]}z(k=1){return(this.next()*2-1)*k}}
const nBind=r=>{const o={};for(const a of AORDER){const s=r&&r[a]?r[a]:DEF_BIND[a];o[a]=Array.isArray(s)?s.slice(0,3):(typeof s==="string"?[s]:DEF_BIND[a].slice())}return o};
const loadSet=()=>Object.assign({},DEF_SET,jParse(localStorage.getItem(STORE.s)||"{}",{}));
const saveSet=s=>localStorage.setItem(STORE.s,JSON.stringify(s));
const loadBind=()=>nBind(jParse(localStorage.getItem(STORE.b)||"{}",{}));
const saveBind=b=>localStorage.setItem(STORE.b,JSON.stringify(b));
const seenTut=()=>localStorage.getItem(STORE.f)==="1"; const setTut=()=>localStorage.setItem(STORE.f,"1");
const tFmt=s=>{s=Math.max(0,Math.floor(s));const m=Math.floor(s/60),r=s%60;return `${m<10?"0":""}${m}:${r<10?"0":""}${r}`};
const bTxt=a=>a.filter(Boolean).map(c=>c==="Mouse0"?"Mouse Left":c==="Mouse1"?"Mouse Mid":c==="Mouse2"?"Mouse Right":c.startsWith("Key")?c.slice(3):c.startsWith("Digit")?c.slice(5):c).join(" / ");
function genTeams(seed){const r=new RNG(seed),names=["Metro Foxes","Harbor Comets","Granite Rovers","Northlight Owls","Ironfield Lynx","Sunvale Arrows"];for(let i=names.length-1;i>0;i--){const j=r.i(0,i);[names[i],names[j]]=[names[j],names[i]]}const fn=["Ari","Nico","Marek","Jules","Teo","Rian","Luca","Emil","Dario","Kai","Oren","Silas","Noel","Pavel","Reed","Tariq","Elio","Vance","Milo","Soren"],ln=["Hale","Cross","Vale","Rook","Keller","Ortega","Finch","Mori","Baxter","Nolan","Sato","Rivas","Gale","Mercer","Voss","Klein","Pryce","Tanner","Ivers","Dane"];const ts=[];for(let t=0;t<2;t++){const ps=[];for(let i=0;i<TEAM_N;i++){const role=FORM[i][2],base=role==="GK"?58:62,sp=role==="GK"?26:30;const rt={speed:clamp(Math.round(base+r.z(sp)),45,95),accel:clamp(Math.round(base+r.z(sp)),45,95),dribble:clamp(Math.round(base+r.z(sp)),45,95),pass:clamp(Math.round(base+r.z(sp)),45,95),shot:clamp(Math.round(base+r.z(sp)),45,95),tackle:clamp(Math.round(base+r.z(sp)),45,95),stamina:clamp(Math.round(base+r.z(sp)),45,95),keeper:role==="GK"?clamp(Math.round(64+r.z(22)),55,97):clamp(Math.round(15+r.z(10)),5,35)};ps.push({id:`${t}-${i}`,number:i===0?1:i+1,role,name:`${r.c(fn)} ${r.c(ln)}`,ratings:rt})}ts.push({id:t,name:names[t],color:t===0?"#ff6b35":"#2f86ff",gkColor:t===0?"#f2c14e":"#8ef9f3",players:ps})}return ts}

class Input{
  constructor(canvas,bind,onGesture){this.canvas=canvas;this.bind=nBind(bind);this.g=onGesture;this.k=Object.create(null);this.m=Object.create(null);this.gp=Object.create(null);this.down=Object.create(null);this.pr=Object.create(null);this.rl=Object.create(null);this.prev=Object.create(null);this.mx=0;this.mz=0;this.lx=0;this.ly=0;this.pl=false;this.rem=null;this.remCb=null;
    addEventListener("keydown",e=>this.kd(e),{passive:false});addEventListener("keyup",e=>this.ku(e),{passive:false});addEventListener("mousedown",e=>this.md(e),{passive:false});addEventListener("mouseup",e=>this.mu(e),{passive:false});addEventListener("mousemove",e=>{if(this.pl){this.lx+=e.movementX*.0022;this.ly+=e.movementY*.0017}},{passive:true});addEventListener("contextmenu",e=>e.preventDefault(),{passive:false});document.addEventListener("pointerlockchange",()=>this.pl=document.pointerLockElement===this.canvas);
  }
  kd(e){if(this.rem){e.preventDefault();this.fin(e.code);return}this.k[e.code]=true;if(e.code==="Tab"||e.code==="Escape")e.preventDefault();this.g&&this.g()}
  ku(e){this.k[e.code]=false}
  md(e){const c="Mouse"+e.button;if(this.rem){e.preventDefault();this.fin(c);return}this.m[c]=true;this.g&&this.g()}
  mu(e){this.m["Mouse"+e.button]=false}
  fin(code){const a=this.rem;if(!a)return;this.bind[a]=[code];this.remCb&&this.remCb(a,this.bind[a]);this.rem=null;this.remCb=null}
  begin(a,cb){this.rem=a;this.remCb=cb}
  reqPL(){this.canvas.requestPointerLock()} relPL(){document.exitPointerLock()}
  is(c){return c.startsWith("Mouse")?!!this.m[c]:!!this.k[c]}
  updGP(){for(const k in this.gp)this.gp[k]=false;let x=0,z=0,lookX=0,lookY=0;const p=navigator.getGamepads?navigator.getGamepads():null;if(!p||!p[0])return{x:0,z:0,lookX:0,lookY:0};const g=p[0],a0=g.axes[0]||0,a1=g.axes[1]||0,a2=g.axes[2]||0,a3=g.axes[3]||0;x=Math.abs(a0)>.15?a0:0;z=Math.abs(a1)>.15?-a1:0;lookX=Math.abs(a2)>.12?a2*.05:0;lookY=Math.abs(a3)>.12?a3*.05:0;const b=g.buttons;this.gp.pass=!!(b[0]&&b[0].pressed);this.gp.shoot=!!(b[1]&&b[1].pressed);this.gp.lob=!!(b[2]&&b[2].pressed);this.gp.through=!!(b[3]&&b[3].pressed);this.gp.switchPlayer=!!(b[4]&&b[4].pressed);this.gp.tackle=!!(b[5]&&b[5].pressed);this.gp.sprint=!!(b[7]&&b[7].value>.2);return{x,z,lookX,lookY}}
  update(){const gp=this.updGP();for(const a of AORDER){let d=false;for(const c of this.bind[a]){if(this.is(c)){d=true;break}}if(this.gp[a])d=true;this.down[a]=d;this.pr[a]=d&&!this.prev[a];this.rl[a]=!d&&!!this.prev[a];this.prev[a]=d}
    let x=(this.down.moveRight?1:0)-(this.down.moveLeft?1:0)+gp.x,z=(this.down.moveUp?1:0)-(this.down.moveDown?1:0)+gp.z;const l=x*x+z*z;if(l>1){const i=1/Math.sqrt(l);x*=i;z*=i}this.mx=x;this.mz=z;this.lx+=gp.lookX;this.ly+=gp.lookY}
  cYaw(){const v=this.lx;this.lx=0;return v} cPitch(){const v=this.ly;this.ly=0;return v}
  d(a){return!!this.down[a]} p(a){return!!this.pr[a]} r(a){return!!this.rl[a]}
}

class AudioE{
  constructor(s){this.s=s;this.ctx=null;this.master=null;this.music=null;this.sfx=null;this.cg=null;this.ct=.12;this.started=false}
  start(){if(this.started)return;this.ctx=new (window.AudioContext||window.webkitAudioContext)();this.master=this.ctx.createGain();this.music=this.ctx.createGain();this.sfx=this.ctx.createGain();this.master.connect(this.ctx.destination);this.music.connect(this.master);this.sfx.connect(this.master);this.master.gain.value=this.s.masterVolume;this.music.gain.value=this.s.musicVolume;this.sfx.gain.value=this.s.sfxVolume;const len=this.ctx.sampleRate*2,b=this.ctx.createBuffer(1,len,this.ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*.22;const src=this.ctx.createBufferSource();src.buffer=b;src.loop=true;const f=this.ctx.createBiquadFilter();f.type="lowpass";f.frequency.value=700;this.cg=this.ctx.createGain();this.cg.gain.value=.12;src.connect(f);f.connect(this.cg);this.cg.connect(this.music);src.start();this.started=true}
  setVol(m,mu,s){this.s.masterVolume=m;this.s.musicVolume=mu;this.s.sfxVolume=s;if(!this.started)return;this.master.gain.value=m;this.music.gain.value=mu;this.sfx.gain.value=s}
  crowd(v){this.ct=clamp(.1+v*.35,.08,.5)} update(){if(!this.started||!this.cg)return;const c=this.cg.gain.value;this.cg.gain.value=c+(this.ct-c)*.04}
  kick(p=1){if(!this.started)return;const n=this.ctx.currentTime,o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type="triangle";o.frequency.setValueAtTime(120+80*p,n);o.frequency.exponentialRampToValueAtTime(55,n+.09);g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.35+p*.25,n+.01);g.gain.exponentialRampToValueAtTime(.0001,n+.12);o.connect(g);g.connect(this.sfx);o.start(n);o.stop(n+.13)}
  whistle(long=false){if(!this.started)return;const n=this.ctx.currentTime,d=long?.36:.19,o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type="square";o.frequency.setValueAtTime(1180,n);o.frequency.linearRampToValueAtTime(990,n+d);g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.28,n+.02);g.gain.exponentialRampToValueAtTime(.0001,n+d);o.connect(g);g.connect(this.sfx);o.start(n);o.stop(n+d+.02)}
  click(){if(!this.started)return;const n=this.ctx.currentTime,o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type="sine";o.frequency.value=720;g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(.08,n+.01);g.gain.exponentialRampToValueAtTime(.0001,n+.08);o.connect(g);g.connect(this.sfx);o.start(n);o.stop(n+.09)}
}

class Replay{
  constructor(sec=10,sr=20){this.sec=sec;this.sr=sr;this.dt=1/sr;this.cap=Math.floor(sec*sr);this.b=new Float32Array(this.cap*6);this.p=new Float32Array(this.cap*TOTAL*3);this.poss=new Int8Array(this.cap);this.w=0;this.c=0;this.acc=0;this.on=false;this.t=0;this.dur=6;this.samples=0;this.start=0}
  clear(){this.w=0;this.c=0;this.acc=0;this.on=false;this.t=0}
  rec(dt,g){this.acc+=dt;while(this.acc>=this.dt){this.acc-=this.dt;let wi=this.w,bi=wi*6;this.b[bi++]=g.ball.pos.x;this.b[bi++]=g.ball.pos.y;this.b[bi++]=g.ball.pos.z;this.b[bi++]=g.ball.vel.x;this.b[bi++]=g.ball.vel.y;this.b[bi++]=g.ball.vel.z;let pi=wi*TOTAL*3;for(let i=0;i<TOTAL;i++){const p=g.players[i];this.p[pi++]=p.pos.x;this.p[pi++]=p.pos.y;this.p[pi++]=p.pos.z}this.poss[wi]=g.possT;this.w=(wi+1)%this.cap;if(this.c<this.cap)this.c++}}
  begin(d=6.2){if(this.c<Math.floor(this.sr*2))return false;this.on=true;this.t=0;this.dur=d;this.samples=Math.min(this.c,Math.floor(d*this.sr));this.start=(this.w-this.samples+this.cap)%this.cap;return true}
  apply(g,sf){const i0=Math.floor(sf),i1=Math.min(i0+1,this.samples-1),t=sf-i0,a=(this.start+i0)%this.cap,b=(this.start+i1)%this.cap;let b0=a*6,b1=b*6;g.ball.pos.x=mix(this.b[b0],this.b[b1],t);b0++;b1++;g.ball.pos.y=mix(this.b[b0],this.b[b1],t);b0++;b1++;g.ball.pos.z=mix(this.b[b0],this.b[b1],t);b0++;b1++;g.ball.vel.x=mix(this.b[b0],this.b[b1],t);b0++;b1++;g.ball.vel.y=mix(this.b[b0],this.b[b1],t);b0++;b1++;g.ball.vel.z=mix(this.b[b0],this.b[b1],t);let p0=a*TOTAL*3,p1=b*TOTAL*3;for(let i=0;i<TOTAL;i++){const p=g.players[i];p.pos.x=mix(this.p[p0],this.p[p1],t);p0++;p1++;p.pos.y=mix(this.p[p0],this.p[p1],t);p0++;p1++;p.pos.z=mix(this.p[p0],this.p[p1],t);p0++;p1++}}
  update(g,dt){if(!this.on)return false;this.t+=dt;this.apply(g,clamp(this.t*this.sr,0,this.samples-1));if(this.t>=this.dur){this.on=false;return true}return false}
}
class SceneM{
  constructor(g){this.g=g;this.cvs=document.getElementById("c");this.r=new THREE.WebGLRenderer({canvas:this.cvs,antialias:true,alpha:false,powerPreference:"high-performance"});this.r.outputColorSpace=THREE.SRGBColorSpace;this.r.setClearColor(0x0f2c1e,1);this.r.setPixelRatio(Math.min(devicePixelRatio,2));this.r.setSize(innerWidth,innerHeight);
    this.s=new THREE.Scene();this.cam=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,500);this.camPos=new THREE.Vector3(0,38,34);this.camLook=new THREE.Vector3();this.camLookNow=new THREE.Vector3();this.camYaw=0;
    this.pm=new Array(TOTAL);this.ps=new Array(TOTAL);this.offA=new Float32Array(6);
    const hemi=new THREE.HemisphereLight(0xc7f4ff,0x1a3b26,.95),sun=new THREE.DirectionalLight(0xffffff,1.02);sun.position.set(40,70,-25);this.s.add(hemi,sun);
    this.pitch();this.indicators();
  }
  texPitch(){const c=document.createElement("canvas");c.width=1024;c.height=1024;const x=c.getContext("2d");x.fillStyle="#2a7f47";x.fillRect(0,0,1024,1024);for(let i=0;i<20;i++){x.fillStyle=i%2?"rgba(0,0,0,.07)":"rgba(255,255,255,.02)";x.fillRect(i*51.2,0,51.2,1024)}x.strokeStyle="#e9fff0";x.lineWidth=6;x.strokeRect(24,24,976,976);x.beginPath();x.moveTo(512,24);x.lineTo(512,1000);x.stroke();x.beginPath();x.arc(512,512,(9.15/68)*976,0,Math.PI*2);x.stroke();const bw=(16.5/105)*976,bh=(40.3/68)*976;x.strokeRect(24,512-bh/2,bw,bh);x.strokeRect(1000-bw,512-bh/2,bw,bh);const t=new THREE.CanvasTexture(c);t.colorSpace=THREE.SRGBColorSpace;return t}
  texBall(){const c=document.createElement("canvas");c.width=256;c.height=256;const x=c.getContext("2d");x.fillStyle="#fff";x.fillRect(0,0,256,256);x.fillStyle="#111";for(let i=0;i<8;i++){const a=i/8*Math.PI*2;x.beginPath();x.arc(128+Math.cos(a)*62,128+Math.sin(a)*62,20,0,Math.PI*2);x.fill()}x.beginPath();x.arc(128,128,28,0,Math.PI*2);x.fill();const t=new THREE.CanvasTexture(c);t.colorSpace=THREE.SRGBColorSpace;return t}
  pitch(){const m=new THREE.Mesh(new THREE.PlaneGeometry(PITCH_L+6,PITCH_W+6),new THREE.MeshStandardMaterial({map:this.texPitch(),roughness:.96,metalness:.02}));m.rotation.x=-Math.PI/2;this.s.add(m);const b=new THREE.Mesh(new THREE.BoxGeometry(PITCH_L+16,.8,PITCH_W+16),new THREE.MeshStandardMaterial({color:0x163726,roughness:1}));b.position.y=-.45;this.s.add(b);const sm=new THREE.MeshStandardMaterial({color:0x11261c,roughness:.95});const sa=new THREE.Mesh(new THREE.BoxGeometry(PITCH_L+30,8,8),sm);sa.position.set(0,3,PITCH_W*.5+8);const sb=sa.clone();sb.position.z=-sa.position.z;const sc=new THREE.Mesh(new THREE.BoxGeometry(8,8,PITCH_W+30),sm);sc.position.set(PITCH_L*.5+8,3,0);const sd=sc.clone();sd.position.x=-sc.position.x;this.s.add(sa,sb,sc,sd);
    const fm=new THREE.MeshStandardMaterial({color:0xffffff,roughness:.44,metalness:.18}),nm=new THREE.MeshStandardMaterial({color:0xdde7ef,roughness:1,opacity:.22,transparent:true});for(let side=-1;side<=1;side+=2){const gx=side*PITCH_L*.5,post=new THREE.BoxGeometry(.16,2.44,.16);const l=new THREE.Mesh(post,fm);l.position.set(gx,1.22,GOAL_W*.5);const r=new THREE.Mesh(post,fm);r.position.set(gx,1.22,-GOAL_W*.5);const bar=new THREE.Mesh(new THREE.BoxGeometry(.16,.16,GOAL_W),fm);bar.position.set(gx,2.44,0);const net=new THREE.Mesh(new THREE.BoxGeometry(2,2.44,GOAL_W),nm);net.position.set(gx-side,1.22,0);this.s.add(l,r,bar,net)}
  }
  indicators(){this.ring=new THREE.Mesh(new THREE.TorusGeometry(.72,.05,9,28),new THREE.MeshBasicMaterial({color:0xffe068,transparent:true,opacity:.9}));this.ring.rotation.x=Math.PI/2;this.ring.position.y=.05;this.s.add(this.ring);this.pmkr=new THREE.Mesh(new THREE.ConeGeometry(.24,.58,12),new THREE.MeshBasicMaterial({color:0x4fe3ff,transparent:true,opacity:.9}));this.pmkr.rotation.x=Math.PI;this.pmkr.visible=false;this.s.add(this.pmkr);this.og=new THREE.BufferGeometry();this.og.setAttribute("position",new THREE.BufferAttribute(this.offA,3));this.oline=new THREE.Line(this.og,new THREE.LineBasicMaterial({color:0xff6767,transparent:true,opacity:.8}));this.oline.visible=false;this.s.add(this.oline)}
  actors(ps,teams,ball){const bg=new THREE.CapsuleGeometry(.36,.72,4,10),hg=new THREE.SphereGeometry(.18,12,10),sg=new THREE.CircleGeometry(.34,14),sm=new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:.28});for(let i=0;i<TOTAL;i++){const p=ps[i],tm=teams[p.team],col=p.role==="GK"?tm.gkColor:tm.color;const g=new THREE.Group(),b=new THREE.Mesh(bg,new THREE.MeshStandardMaterial({color:col,roughness:.82,metalness:.03}));b.position.y=.9;const h=new THREE.Mesh(hg,new THREE.MeshStandardMaterial({color:0xf4d9b2,roughness:.9}));h.position.y=1.58;g.add(b,h);this.s.add(g);p.mesh=g;this.pm[i]=g;const sh=new THREE.Mesh(sg,sm);sh.rotation.x=-Math.PI/2;sh.position.y=.02;this.s.add(sh);this.ps[i]=sh}
    this.ball=new THREE.Mesh(new THREE.SphereGeometry(ball.radius,20,18),new THREE.MeshStandardMaterial({map:this.texBall(),roughness:.55,metalness:.03}));this.s.add(this.ball);this.bs=new THREE.Mesh(new THREE.CircleGeometry(ball.radius*1.8,18),new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:.25}));this.bs.rotation.x=-Math.PI/2;this.s.add(this.bs);this.cam.position.copy(this.camPos);this.camLookNow.set(0,0,0);this.cam.lookAt(this.camLookNow)
  }
  quality(q){this.r.setPixelRatio(q==="low"?1:q==="medium"?Math.min(devicePixelRatio,1.4):Math.min(devicePixelRatio,2))}
  updActors(){const g=this.g;for(let i=0;i<TOTAL;i++){const p=g.players[i],m=this.pm[i];m.position.copy(p.pos);m.rotation.y=p.facing;const sh=this.ps[i];sh.position.x=p.pos.x;sh.position.z=p.pos.z}this.ball.position.copy(g.ball.pos);this.ball.rotation.x+=g.ball.vel.z*.015;this.ball.rotation.z-=g.ball.vel.x*.015;this.bs.position.set(g.ball.pos.x,.02,g.ball.pos.z);const sc=clamp(1-(g.ball.pos.y-BALL_R)*.42,.35,1);this.bs.scale.setScalar(sc)}
  updInd(){const g=this.g,s=g.players[g.selI];this.ring.position.set(s.pos.x,.05,s.pos.z);if(g.passI>=0){const t=g.players[g.passI];this.pmkr.visible=true;this.pmkr.position.set(t.pos.x,2,t.pos.z);this.pmkr.rotation.y=g.clock*2.2}else this.pmkr.visible=false;
    if(g.settings.offside&&g.rules.state==="live"&&g.possT>=0){const x=g.offsideLine(g.possT),a=this.offA;a[0]=x;a[1]=.08;a[2]=-PITCH_W*.5;a[3]=x;a[4]=.08;a[5]=PITCH_W*.5;this.og.attributes.position.needsUpdate=true;this.oline.visible=true}else this.oline.visible=false}
  updCam(dt){const g=this.g,b=g.ball.pos,s=g.players[g.selI];if(g.replay.on){const t=g.replay.t,r=15+Math.sin(t*1.4)*2;this.camPos.set(b.x+Math.cos(t*.9)*r,10+Math.sin(t*1.1)*1.5,b.z+Math.sin(t*.9)*r);this.camLook.set(b.x,b.y+1,b.z)}else if(g.settings.cameraMode==="chase"){let fa=s.facing;const sp=Math.hypot(s.vel.x,s.vel.z);if(sp>.4){const va=Math.atan2(s.vel.x,s.vel.z);fa+=wAng(va-fa)*.35}const dx=Math.sin(fa),dz=Math.cos(fa),dist=mix(7.8,10.2,clamp(sp/9,0,1)),h=mix(4.8,6.2,clamp(sp/9,0,1)),lead=3.8+sp*.22;this.camPos.set(s.pos.x-dx*dist+s.vel.x*.22,h,s.pos.z-dz*dist+s.vel.z*.22);this.camLook.set(s.pos.x+dx*lead,s.pos.y+1.7,s.pos.z+dz*lead)}else{const lx=b.x+g.ball.vel.x*.55,lz=b.z+g.ball.vel.z*.55,fx=mix(lx,s.pos.x,.18),fz=mix(lz,s.pos.z,.18);this.camPos.set(clamp(fx*.56,-28,28),37+Math.abs(fx)*.03,32+fz*.22);this.camLook.set(fx*.74,.35,fz*.84)}const pk=g.settings.reduceMotion?1:clamp(dt*8.2,0,1),lk=g.settings.reduceMotion?1:clamp(dt*10.4,0,1);this.cam.position.lerp(this.camPos,pk);this.camLookNow.lerp(this.camLook,lk);this.cam.lookAt(this.camLookNow);this.camYaw=Math.atan2(this.cam.position.x-this.camLookNow.x,this.cam.position.z-this.camLookNow.z)}
  y(){return this.camYaw}
  resize(){this.cam.aspect=innerWidth/innerHeight;this.cam.updateProjectionMatrix();this.r.setSize(innerWidth,innerHeight)}
  render(dt){this.updActors();this.updInd();this.updCam(dt);this.r.render(this.s,this.cam)}
}

class Phys{
  constructor(t){this.t=t}
  step(g,dt){this.players(g,dt);this.ball(g,dt);this.contacts(g,dt)}
  players(g,dt){const t=this.t;for(let i=0;i<TOTAL;i++){const p=g.players[i],r=p.ratings;let ix=p.ix,iz=p.iz,l=ix*ix+iz*iz;if(l>1){const k=1/Math.sqrt(l);ix*=k;iz*=k}const sf=.72+r.speed*.0042,af=.70+r.accel*.0045,max=(p.spr&&p.stam>.08)?t.playerMaxSpeed*sf*t.sprintMultiplier:t.playerMaxSpeed*sf,ac=t.playerAccel*af;const tvx=ix*max,tvz=iz*max;p.vel.x+=clamp(tvx-p.vel.x,-ac*dt,ac*dt);p.vel.z+=clamp(tvz-p.vel.z,-ac*dt,ac*dt);if(l<.0001){p.vel.x*=.84;p.vel.z*=.84}if(p.slide>0){p.slide-=dt;p.vel.x*=.992;p.vel.z*=.992}p.pos.x+=p.vel.x*dt;p.pos.z+=p.vel.z*dt;p.pos.x=clamp(p.pos.x,-PITCH_L*.5-2.4,PITCH_L*.5+2.4);p.pos.z=clamp(p.pos.z,-PITCH_W*.5-2.4,PITCH_W*.5+2.4);p.pos.y=0;const sp=p.vel.x*p.vel.x+p.vel.z*p.vel.z;if(sp>.02){const a=Math.atan2(p.vel.x,p.vel.z),d=wAng(a-p.facing);p.facing+=clamp(d,-t.turnRate*dt,t.turnRate*dt)}const sg=p.spr?-t.staminaDrain:t.staminaRegen,st=.7+r.stamina*.0035;p.stam=clamp(p.stam+sg*dt*st,0,1)}}
  ball(g,dt){const b=g.ball,t=this.t;b.vel.y-=9.81*dt;const dr=1/(1+t.ballAirDrag*dt);b.vel.x*=dr;b.vel.y*=dr;b.vel.z*=dr;const lx=b.spin.y*b.vel.z-b.spin.z*b.vel.y,ly=b.spin.z*b.vel.x-b.spin.x*b.vel.z,lz=b.spin.x*b.vel.y-b.spin.y*b.vel.x;b.vel.x+=clamp(lx*t.magnus*dt,-.45,.45);b.vel.y+=clamp(ly*t.magnus*dt,-.35,.35);b.vel.z+=clamp(lz*t.magnus*dt,-.45,.45);b.pos.x+=b.vel.x*dt;b.pos.y+=b.vel.y*dt;b.pos.z+=b.vel.z*dt;if(b.pos.y<BALL_R){b.pos.y=BALL_R;if(b.vel.y<0)b.vel.y=-b.vel.y*t.ballBounce;b.vel.x*=t.ballFriction;b.vel.z*=t.ballFriction;b.spin.multiplyScalar(.985)}if(g.settings.trainingMode){const mx=PITCH_L*.5,mz=PITCH_W*.5;if(b.pos.x<-mx||b.pos.x>mx){b.pos.x=clamp(b.pos.x,-mx,mx);b.vel.x=-b.vel.x*.74}if(b.pos.z<-mz||b.pos.z>mz){b.pos.z=clamp(b.pos.z,-mz,mz);b.vel.z=-b.vel.z*.74}}}
  contacts(g,dt){const b=g.ball,t=this.t;let cand=-1,best=1e9;for(let i=0;i<TOTAL;i++){const p=g.players[i],dx=b.pos.x-p.pos.x,dz=b.pos.z-p.pos.z,ds=dx*dx+dz*dz,c=P_R+BALL_R;if(ds<c*c){const d=Math.sqrt(Math.max(ds,1e-8)),nx=dx/d,nz=dz/d,pen=c-d;b.pos.x+=nx*pen;b.pos.z+=nz*pen;const rel=b.vel.x*nx+b.vel.z*nz-(p.vel.x*nx+p.vel.z*nz);if(rel<0){const imp=-rel*.62;b.vel.x+=nx*imp;b.vel.z+=nz*imp}b.lastT=p.team;b.lastP=i}const z=P_R+.72;if(ds<z*z&&b.pos.y<1.1){const sp=Math.hypot(b.vel.x,b.vel.z);if(sp<13||p.role==="GK"){if(ds<best){best=ds;cand=i}}}}
    if(cand>=0&&g.rules.state==="live"){b.owner=cand;const o=g.players[cand];g.possT=o.team;g.possP=cand}else if(Math.hypot(b.vel.x,b.vel.y,b.vel.z)>17)b.owner=-1;
    if(b.owner>=0){const p=g.players[b.owner],fx=p.pos.x+Math.sin(p.facing)*.62+p.vel.x*.02,fz=p.pos.z+Math.cos(p.facing)*.62+p.vel.z*.02,dx=fx-b.pos.x,dz=fz-b.pos.z,dy=BALL_R-b.pos.y;b.vel.x+=dx*t.dribbleSpring*dt;b.vel.z+=dz*t.dribbleSpring*dt;b.vel.y+=dy*t.dribbleSpring*dt;const dp=1/(1+t.dribbleDamping*dt);b.vel.x*=dp;b.vel.z*=dp;if(b.vel.y>5)b.vel.y=5;b.lastT=p.team;b.lastP=b.owner}
  }
}
class AI{
  constructor(){this.phase=["Defend","Defend"];this.press=[-1,-1]}
  upd(g,dt){if(g.settings.trainingMode){for(let i=0;i<TOTAL;i++){if(g.players[i].team===0&&i===g.selI)continue;const p=g.players[i];p.ix=0;p.iz=0;p.spr=false;p.ai="idle(training)"}this.phase=["Training","Training"];return}
    const pt=g.possT;for(let t=0;t<2;t++){this.phase[t]=pt===t?"Attack":pt===-1?"Transition":"Defend";this.press[t]=this.phase[t]==="Defend"?g.nearBall(t,false):-1}
    for(let i=0;i<TOTAL;i++){const p=g.players[i];if(p.team===0&&i===g.selI)continue;this.ctrl(g,i,dt)}
  }
  steer(p,x,z,s){const dx=x-p.pos.x,dz=z-p.pos.z,l=Math.hypot(dx,dz);if(l>.001){p.ix=dx/l;p.iz=dz/l}else{p.ix=0;p.iz=0}p.spr=s}
  ctrl(g,i,dt){const p=g.players[i],ph=this.phase[p.team],pr=g.diff;if(p.role==="GK"){this.gk(g,i,dt);return}if(g.ball.owner===i){this.car(g,i,dt,pr);return}if(ph==="Defend"&&this.press[p.team]===i){this.steer(p,g.ball.pos.x,g.ball.pos.z,true);p.ai="press";return}g.homeDyn(p,p.target);if(ph==="Attack"){const d=g.adir(p.team);if(p.role==="FWD")p.target.x+=d*9;if(p.role==="MID")p.target.x+=d*4;p.ai="support"}else if(ph==="Defend"){p.target.x-=g.adir(p.team)*2;p.ai="mark"}else p.ai="transition";this.steer(p,p.target.x,p.target.z,p.role==="FWD"||Math.hypot(p.target.x-p.pos.x,p.target.z-p.pos.z)>7)}
  car(g,i,dt,pr){const p=g.players[i];p.dec-=dt;const od=g.nearOpp(i),d=g.adir(p.team),gx=d>0?PITCH_L*.5:-PITCH_L*.5,dist=Math.abs(gx-p.pos.x);if(p.dec<=0){if(dist<24&&Math.abs(p.pos.z)<16){if(g.shot(i,.78,false,false,true)){p.dec=pr.reaction+.16;p.ai="shoot";return}}if(od<2.4){if(g.pass(i,od<1.4?"lob":"pass",-1,true)){p.dec=pr.reaction+.12;p.ai="pass";return}}p.dec=Math.max(.09,pr.reaction*.6)}p.ix=d;p.iz=clamp(-p.pos.z*.02,-.6,.6);p.spr=od<2.6;p.ai="carry"}
  gk(g,i,dt){const p=g.players[i],side=g.sides[p.team],gx=side*PITCH_L*.5,tx=gx-side*1.8,tz=clamp(g.ball.pos.z*.23,-GOAL_W*.8,GOAL_W*.8);this.steer(p,tx,tz,false);p.ai="gk-pos";if(g.ball.owner===i){p.hold-=dt;p.ix=0;p.iz=0;p.spr=false;p.ai="gk-hold";if(p.hold<=0&&g.pass(i,"pass",-1,true))p.hold=1;return}const d=Math.hypot(g.ball.pos.x-p.pos.x,g.ball.pos.z-p.pos.z);if(d<1.7&&g.ball.pos.y<1.3&&g.ball.owner<0){g.ball.owner=i;g.ball.vel.set(0,0,0);g.possT=p.team;g.possP=i;p.hold=.8;p.ai="gk-catch"}}
}

class Rules{
  constructor(){this.state="menu";this.a=0;this.b=0;this.h=1;this.clock=0;this.kick=0;this.pre="live";this.t=0;this.rTeam=0;this.rType="kickoff";this.rx=0;this.rz=0}
  start(g,training){this.a=0;this.b=0;this.h=1;this.clock=0;this.kick=0;this.rTeam=0;this.state="kickoff";this.t=1.25;this.rType="kickoff";g.sides=[-1,1];g.reset(this.kick);g.ball.pos.set(0,BALL_R,0);g.ball.vel.set(0,0,0);g.ball.owner=g.kPlayer(this.kick);g.possT=this.kick;g.possP=g.ball.owner;g.audio.whistle(true);g.ui.note(training?"Training started":"Kickoff")}
  pause(g){if(this.state==="paused")return;this.pre=this.state;this.state="paused";g.ui.pause(true)}
  resume(g){if(this.state!=="paused")return;this.state=this.pre;g.ui.pause(false)}
  restart(g,team,type,x,z,time=1){this.state="restart";this.rTeam=team;this.rType=type;this.rx=x;this.rz=z;this.t=time;g.ball.owner=-1;g.ball.pos.set(x,BALL_R,z);g.ball.vel.set(0,0,0);g.possT=team;g.possP=-1;g.ui.note(type==="throwin"?"Throw-in":type==="corner"?"Corner":type==="goalkick"?"Goal Kick":"Free Kick")}
  goal(g,sc){if(sc===0)this.a++;else this.b++;this.state="goal";this.t=.9;this.rTeam=1-sc;this.kick=this.rTeam;g.audio.whistle(false);g.audio.crowd(1);g.ui.note(`${g.teams[sc].name} scored!`)}
  half(g){this.state="halftime";this.t=2.6;g.audio.whistle(true);g.ui.note("Halftime");g.swap();g.reset(1-this.kick)}
  full(g){this.state="fulltime";g.audio.whistle(true);g.ui.note("Full time")}
  upd(g,dt){if(["menu","paused","fulltime","replay"].includes(this.state))return;
    if(this.state==="kickoff"||this.state==="restart"){this.t-=dt;if(this.t<=0){this.state="live";g.ui.note("Play")}return}
    if(this.state==="goal"){this.t-=dt;if(this.t<=0){if(g.replay.begin(6.2)){this.state="replay";g.ui.note("Replay")}else{this.state="kickoff";this.t=1.2;g.reset(this.kick);g.ball.pos.set(0,BALL_R,0);g.ball.vel.set(0,0,0);g.ball.owner=g.kPlayer(this.kick);g.possT=this.kick}}return}
    if(this.state==="halftime"){this.t-=dt;if(this.t<=0){this.h=2;this.state="kickoff";this.t=1.2;this.kick=1-this.kick;g.reset(this.kick);g.ball.pos.set(0,BALL_R,0);g.ball.vel.set(0,0,0);g.ball.owner=g.kPlayer(this.kick);g.possT=this.kick;g.audio.whistle(false)}return}
    if(!g.settings.trainingMode){this.clock+=dt;const hs=g.settings.halfLengthMin*60;if(this.h===1&&this.clock>=hs){this.half(g);return}if(this.h===2&&this.clock>=hs*2){this.full(g);return}}
    const bx=g.ball.pos.x,bz=g.ball.pos.z,by=g.ball.pos.y,cross=Math.abs(bx)>PITCH_L*.5;if(cross&&Math.abs(bz)<=GOAL_W*.5&&by<=GOAL_H){const gs=bx>0?1:-1,con=g.teamAt(gs),sc=1-con;this.goal(g,sc);return}
    const outS=Math.abs(bz)>PITCH_W*.5,outE=Math.abs(bx)>PITCH_L*.5;if(outS||outE){const last=g.ball.lastT>=0?g.ball.lastT:(g.possT>=0?g.possT:0);if(outS){const team=1-last,x=clamp(bx,-PITCH_L*.5+1,PITCH_L*.5-1),z=bz>0?PITCH_W*.5-.8:-PITCH_W*.5+.8;this.restart(g,team,"throwin",x,z,1);return}if(outE){const side=bx>0?1:-1,def=g.teamAt(side);if(last===def){const att=1-def,z=bz>=0?PITCH_W*.5-.9:-PITCH_W*.5+.9,x=side*(PITCH_L*.5-.9);this.restart(g,att,"corner",x,z,1)}else{const x=side*(PITCH_L*.5-8.5);this.restart(g,def,"goalkick",x,0,1)}return}}
  }
}
class UI{
  constructor(g){this.g=g;const $=id=>document.getElementById(id);this.e={overlay:$("overlay"),notice:$("notice"),debug:$("debug"),dev:$("dev"),ptr:$("ptr"),tA:$("tA"),tB:$("tB"),sA:$("sA"),sB:$("sB"),clk:$("clk"),sel:$("sel"),stam:$("stam"),stamTxt:$("stamTxt"),mode:$("mode"),rpl:$("rpl"),phase:$("phase"),pos:$("pos"),shot:$("shot"),shotFill:$("shotFill"),menu:$("menu"),pause:$("pause"),tutorial:$("tutorial"),map:$("map")};this.mm=this.e.map.getContext("2d");this.fps=0;this.fa=0;this.ff=0;this.nt=0;this.bindBtns={};this.bind();this.ctrlList();this.devPanel();this.pullIn();this.accClass()}
  bind(){const q=(s,r=document)=>Array.from(r.querySelectorAll(s));for(const b of q("[data-open]",this.e.menu))b.onclick=()=>{this.g.audio.start();this.g.audio.click();this.show(b.dataset.open)};for(const b of q("[data-start]",this.e.menu))b.onclick=()=>{this.g.audio.start();this.g.audio.click();this.g.start(b.dataset.start==="training")};for(const b of q("[data-open-pause]",this.e.pause))b.onclick=()=>{this.g.audio.click();this.e.pause.style.display="none";this.e.menu.style.display="flex";this.show(b.dataset.openPause)};
    document.getElementById("openTut").onclick=()=>{this.g.audio.click();this.openTut()};document.getElementById("closeTut").onclick=()=>{setTut();this.closeTut();this.g.audio.click()};document.getElementById("resume").onclick=()=>{this.g.audio.click();this.g.rules.resume(this.g)};document.getElementById("restart").onclick=()=>{this.g.audio.click();this.g.start(this.g.settings.trainingMode)};document.getElementById("quit").onclick=()=>{this.g.audio.click();this.g.quit()};document.getElementById("resetBind").onclick=()=>{this.g.bind=nBind(DEF_BIND);this.g.input.bind=nBind(this.g.bind);saveBind(this.g.bind);this.refCtrl();this.g.audio.click()};
    const ids=["difficulty","half","fouls","offside","postfx","camMode","assistPass","assistShot","ptrPref","quality","volM","volMu","volS","cb","rm","hud"];for(const id of ids){const el=document.getElementById(id);el.onchange=()=>{this.g.audio.click();this.pullOut()};if(el.type==="range")el.oninput=()=>this.pullOut()}
  }
  ctrlList(){const list=document.getElementById("ctrl");list.innerHTML="";for(const a of AORDER){const row=document.createElement("div");row.className="ci";row.innerHTML=`<div class='n'>${ACT[a]}</div>`;const b=document.createElement("button");b.className="bind";b.textContent=bTxt(this.g.bind[a]);b.onclick=()=>{this.g.audio.click();this.g.input.begin(a,(k,v)=>{this.g.bind[k]=v.slice();saveBind(this.g.bind);this.refCtrl()});this.refCtrl(a)};row.appendChild(b);list.appendChild(row);this.bindBtns[a]=b}}
  refCtrl(wait=null){for(const a of AORDER){const b=this.bindBtns[a];b.textContent=bTxt(this.g.bind[a]);b.classList.toggle("wait",wait===a);if(wait===a)b.textContent="Press key..."}}
  devPanel(){const wrap=this.e.dev;wrap.innerHTML="<div style='font-weight:700;color:var(--acc);margin-bottom:6px'>Dev Panel</div>";const mk=(k,min,max,step)=>{const r=document.createElement("div");r.className="dev";const l=document.createElement("label");l.textContent=k;const h=document.createElement("div");h.style.display="grid";h.style.gridTemplateColumns="1fr auto";h.style.gap="6px";const i=document.createElement("input");i.type="range";i.min=min;i.max=max;i.step=step;i.value=this.g.tune[k];const v=document.createElement("div");v.className="v";v.textContent=Number(this.g.tune[k]).toFixed(2);i.oninput=()=>{const n=Number(i.value);this.g.tune[k]=n;v.textContent=n.toFixed(2)};h.append(i,v);r.append(l,h);wrap.append(r)};mk("sprintMultiplier",1.05,1.8,.01);mk("passPower",10,40,.1);mk("shotPower",14,52,.1);mk("ballFriction",.94,.999,.001);mk("aiPress",.35,1.2,.01)}
  show(id){for(const s of this.e.menu.querySelectorAll(".scr"))s.classList.remove("on");const t=document.getElementById(id);if(t)t.classList.add("on")}
  openTut(){this.e.tutorial.style.display="flex"}
  closeTut(){this.e.tutorial.style.display="none"}
  menu(on=true){this.e.menu.style.display=on?"flex":"none";if(on)this.show("main")} pause(on){this.e.pause.style.display=on?"flex":"none"}
  note(t,d=1.3){this.e.notice.textContent=t;this.e.notice.classList.add("on");this.nt=d}
  pullOut(){const s=this.g.settings;s.difficulty=document.getElementById("difficulty").value;s.halfLengthMin=Number(document.getElementById("half").value);s.fouls=document.getElementById("fouls").checked;s.offside=document.getElementById("offside").checked;s.postFx=document.getElementById("postfx").checked;s.cameraMode=document.getElementById("camMode").value;s.assistPass=document.getElementById("assistPass").checked;s.assistShot=document.getElementById("assistShot").checked;s.pointerLockPreferred=document.getElementById("ptrPref").checked;s.quality=document.getElementById("quality").value;s.masterVolume=Number(document.getElementById("volM").value);s.musicVolume=Number(document.getElementById("volMu").value);s.sfxVolume=Number(document.getElementById("volS").value);s.colorBlind=document.getElementById("cb").checked;s.reduceMotion=document.getElementById("rm").checked;s.hudScale=Number(document.getElementById("hud").value);saveSet(s);this.g.onSet()}
  pullIn(){const s=this.g.settings;document.getElementById("difficulty").value=s.difficulty;document.getElementById("half").value=String(s.halfLengthMin);document.getElementById("fouls").checked=s.fouls;document.getElementById("offside").checked=s.offside;document.getElementById("postfx").checked=s.postFx;document.getElementById("camMode").value=s.cameraMode;document.getElementById("assistPass").checked=s.assistPass;document.getElementById("assistShot").checked=s.assistShot;document.getElementById("ptrPref").checked=s.pointerLockPreferred;document.getElementById("quality").value=s.quality;document.getElementById("volM").value=s.masterVolume;document.getElementById("volMu").value=s.musicVolume;document.getElementById("volS").value=s.sfxVolume;document.getElementById("cb").checked=s.colorBlind;document.getElementById("rm").checked=s.reduceMotion;document.getElementById("hud").value=String(s.hudScale)}
  accClass(){document.body.classList.toggle("cb",!!this.g.settings.colorBlind);document.body.classList.toggle("rm",!!this.g.settings.reduceMotion);document.body.classList.toggle("fx",!!this.g.settings.postFx);this.e.overlay.style.transform=`scale(${this.g.settings.hudScale})`}
  dbg(on){this.e.debug.style.display=on?"block":"none"} dev(on){this.e.dev.style.display=on?"block":"none"}
  minimap(){const c=this.mm,w=this.e.map.width,h=this.e.map.height;c.clearRect(0,0,w,h);c.fillStyle="#143521";c.fillRect(0,0,w,h);c.strokeStyle="rgba(255,255,255,.45)";c.lineWidth=1;c.strokeRect(2,2,w-4,h-4);c.beginPath();c.moveTo(w*.5,2);c.lineTo(w*.5,h-2);c.stroke();c.beginPath();c.arc(w*.5,h*.5,h*.12,0,Math.PI*2);c.stroke();const mx=x=>((x/PITCH_L)+.5)*w,mz=z=>((z/PITCH_W)+.5)*h;for(let i=0;i<TOTAL;i++){const p=this.g.players[i];c.beginPath();c.fillStyle=p.team===0?getComputedStyle(document.body).getPropertyValue("--a").trim():getComputedStyle(document.body).getPropertyValue("--b").trim();c.arc(mx(p.pos.x),mz(p.pos.z),i===this.g.selI?3.8:2.8,0,Math.PI*2);c.fill()}c.beginPath();c.fillStyle="#fff";c.arc(mx(this.g.ball.pos.x),mz(this.g.ball.pos.z),2.4,0,Math.PI*2);c.fill()}
  upd(dt){if(this.nt>0){this.nt-=dt;if(this.nt<=0)this.e.notice.classList.remove("on")}this.e.tA.textContent=this.g.teams[0].name;this.e.tB.textContent=this.g.teams[1].name;this.e.sA.textContent=this.g.rules.a;this.e.sB.textContent=this.g.rules.b;this.e.clk.textContent=`${this.g.settings.trainingMode?"TRAINING":tFmt(this.g.rules.clock)} | ${this.g.rules.h}H`;
    const p=this.g.players[this.g.selI],st=Math.round(p.stam*100);this.e.sel.textContent=p.name;this.e.stamTxt.textContent=`${st}%`;this.e.stam.style.width=`${st}%`;
    this.e.pos.textContent=this.g.possT>=0?this.g.teams[this.g.possT].name:"Loose";this.e.phase.textContent=`${this.g.ai.phase[0]} / ${this.g.ai.phase[1]}`;this.e.mode.textContent=this.g.rules.state;this.e.rpl.textContent=this.g.replay.on?"Playing":"Idle";this.e.ptr.textContent=`Pointer: ${this.g.input.pl?"On":"Off"}`;
    if(this.g.charging){this.e.shot.classList.add("on");this.e.shotFill.style.width=`${Math.round(this.g.chargeN*100)}%`}else this.e.shot.classList.remove("on");
    this.minimap();this.fa+=dt;this.ff++;if(this.fa>=.25){this.fps=Math.round(this.ff/this.fa);this.fa=0;this.ff=0}
    if(this.g.settings.debugOverlay){const b=this.g.ball,sp=Math.hypot(b.vel.x,b.vel.y,b.vel.z),s=this.g.players[this.g.selI];this.e.debug.textContent=`FPS: ${this.fps}\nSim dt: ${this.g.fix.toFixed(4)} (${this.g.slow?"0.5x":"1.0x"})\nBall speed: ${sp.toFixed(2)}\nBall owner: ${b.owner}\nPossession: ${this.g.possT}\nSelected: #${this.g.selI} ${s.name}\nAI phase: ${this.g.ai.phase[0]} / ${this.g.ai.phase[1]}\nAI state sel: ${s.ai}\nRules state: ${this.g.rules.state}\nReplay samples: ${this.g.replay.c}/${this.g.replay.cap}`}
  }
}

// Required architecture aliases (single-file module pattern)
const SceneMgr = SceneM;
const Physics = Phys;
const Audio = AudioE;

class Game{
  constructor(){this.settings=loadSet();this.bind=loadBind();this.tune=Object.assign({},TUNE);this.diff=DIFF[this.settings.difficulty];this.rng=new RNG(SEED);this.teams=genTeams(SEED);this.sides=[-1,1];this.players=[];this.ball={pos:new THREE.Vector3(0,BALL_R,0),vel:new THREE.Vector3(),spin:new THREE.Vector3(),radius:BALL_R,owner:-1,lastT:-1,lastP:-1};this.possT=-1;this.possP=-1;this.selI=0;this.passI=-1;this.passP=new THREE.Vector3();this.aim=0;this.slow=false;this.charging=false;this.charge=0;this.chargeN=0;this.clock=0;this.fix=FIX;this.acc=0;this.last=performance.now()*1e-3;this.runFlag=true;this.active=false;this.devOn=false;this.makePlayers();this.audio=new AudioE(this.settings);this.scene=new SceneM(this);this.scene.actors(this.players,this.teams,this.ball);this.input=new Input(this.scene.cvs,this.bind,()=>this.audio.start());this.phys=new Phys(this.tune);this.ai=new AI();this.rules=new Rules();this.replay=new Replay(10,20);this.ui=new UI(this);this.onSet();this.ui.dbg(!!this.settings.debugOverlay);addEventListener("resize",()=>this.scene.resize())}
  onSet(){saveSet(this.settings);this.scene.quality(this.settings.quality);this.diff=DIFF[this.settings.difficulty];this.audio.setVol(this.settings.masterVolume,this.settings.musicVolume,this.settings.sfxVolume);this.ui.accClass()}
  makePlayers(){this.players.length=0;for(let t=0;t<2;t++)for(let s=0;s<TEAM_N;s++){const d=this.teams[t].players[s];this.players.push({idx:t*TEAM_N+s,team:t,slot:s,role:d.role,name:d.name,ratings:d.ratings,pos:new THREE.Vector3(),vel:new THREE.Vector3(),home:new THREE.Vector3(),target:new THREE.Vector3(),ix:0,iz:0,spr:false,facing:t===0?Math.PI*.5:-Math.PI*.5,stam:1,dec:0,slide:0,hold:.8,ai:"idle",mesh:null})}this.home();this.reset(0)}
  home(){for(const p of this.players){const side=this.sides[p.team],f=FORM[p.slot];p.home.x=f[0]*-side;p.home.z=f[1];p.home.y=0}}
  homeDyn(p,out){const side=this.sides[p.team],f=FORM[p.slot];out.x=f[0]*-side;out.z=f[1];const bx=this.ball.pos.x*.14,bz=this.ball.pos.z*.18;if(this.ai.phase[p.team]==="Attack"){out.x+=bx*.6;out.z+=bz*.35}else if(this.ai.phase[p.team]==="Defend"){out.x+=bx*.25;out.z+=bz*.18}else{out.x+=bx*.4;out.z+=bz*.25}}
  reset(k){this.home();for(const p of this.players){p.pos.copy(p.home);p.vel.set(0,0,0);p.stam=1;p.dec=this.rng.r(.02,.2);p.slide=0;p.hold=.7;p.ai="reset";p.facing=this.adir(p.team)>0?Math.PI*.5:-Math.PI*.5}this.ball.pos.set(0,BALL_R,0);this.ball.vel.set(0,0,0);this.ball.spin.set(0,0,0);this.ball.owner=this.kPlayer(k);this.ball.lastT=k;this.ball.lastP=this.ball.owner;this.possT=k;this.possP=this.ball.owner;this.selI=k===0?this.ball.owner:this.nearBall(0,true);this.passI=-1}
  teamAt(side){return this.sides[0]===side?0:1} adir(t){return-this.sides[t]} swap(){this.sides[0]*=-1;this.sides[1]*=-1;this.home()} kPlayer(t){return t*TEAM_N+9}
  nearBall(team,incGK){let bi=-1,bs=1e9;for(let i=team*TEAM_N;i<team*TEAM_N+TEAM_N;i++){const p=this.players[i];if(!incGK&&p.role==="GK")continue;const dx=p.pos.x-this.ball.pos.x,dz=p.pos.z-this.ball.pos.z,d=dx*dx+dz*dz;if(d<bs){bs=d;bi=i}}return bi}
  nearOpp(i){const p=this.players[i],e=1-p.team;let b=999;for(let j=e*TEAM_N;j<e*TEAM_N+TEAM_N;j++){const q=this.players[j],d=Math.hypot(q.pos.x-p.pos.x,q.pos.z-p.pos.z);if(d<b)b=d}return b}
  offsideLine(att){const def=1-att,d=this.adir(att);let a=d>0?-999:999,b=d>0?-999:999;for(let i=def*TEAM_N;i<def*TEAM_N+TEAM_N;i++){const x=this.players[i].pos.x;if(d>0){if(x>a){b=a;a=x}else if(x>b)b=x}else{if(x<a){b=a;a=x}else if(x<b)b=x}}return b}
  offside(att,ri){if(!this.settings.offside)return false;const r=this.players[ri],d=this.adir(att),l=this.offsideLine(att);return d>0?(r.pos.x>l&&r.pos.x>0):(r.pos.x<l&&r.pos.x<0)}
  start(training){this.settings.trainingMode=!!training;saveSet(this.settings);this.active=true;this.rules.start(this,training);this.replay.clear();this.ui.menu(false);this.ui.pause(false);if(training)this.ui.note("Training mode (no AI, no timer)");if(!seenTut())this.ui.e.tutorial.style.display="flex"}
  quit(){this.active=false;this.rules.state="menu";this.ui.menu(true);this.ui.pause(false)}
  sw(){const t=0;let bi=-1,bs=1e9;for(let i=t*TEAM_N;i<t*TEAM_N+TEAM_N;i++){const p=this.players[i],dx=p.pos.x-this.ball.pos.x,dz=p.pos.z-this.ball.pos.z,d=dx*dx+dz*dz+(i===this.selI?4.5:0);if(d<bs){bs=d;bi=i}}if(bi>=0)this.selI=bi}
  canKick(i){const p=this.players[i],dx=p.pos.x-this.ball.pos.x,dz=p.pos.z-this.ball.pos.z,cl=dx*dx+dz*dz<1.7*1.7;return this.ball.owner===i||(this.ball.owner<0&&cl)}
  findTarget(i,type,out){const p=this.players[i],t=p.team,d=this.adir(t);let ax=Math.sin(p.facing),az=Math.cos(p.facing);if(Math.abs(this.input.mx)+Math.abs(this.input.mz)>.12){const cy=this.scene.y(),mx=this.input.mx,mz=this.input.mz;ax=mx*Math.cos(cy)-mz*Math.sin(cy);az=-mz*Math.cos(cy)-mx*Math.sin(cy);const l=Math.hypot(ax,az);if(l>.001){ax/=l;az/=l}}
    let bi=-1,bs=-1e9;for(let j=t*TEAM_N;j<t*TEAM_N+TEAM_N;j++){if(j===i)continue;const q=this.players[j];let tx=q.pos.x,tz=q.pos.z;if(type==="through")tx+=d*4.2;if(type==="lob")tx+=d*2.2;const dx=tx-p.pos.x,dz=tz-p.pos.z,dist=Math.hypot(dx,dz);if(dist<2||dist>38)continue;const ndx=dx/dist,ndz=dz/dist,al=ndx*ax+ndz*az,fw=d>0?ndx:-ndx,sp=this.nearOpp(j);let sc=al*2.1+fw*1.35+clamp((sp-1.5)*.5,-1.3,2.2);if(this.settings.assistPass)sc+=.25;if(sc>bs){bs=sc;bi=j;out.x=tx;out.y=BALL_R;out.z=tz}}
    return bi}
  pass(i,type="pass",forced=-1,isAI=false){if(!this.canKick(i))return false;const p=this.players[i],team=p.team;let ti=forced;if(ti<0){ti=this.findTarget(i,type,this.passP);if(ti<0)return false}else{const t=this.players[ti];this.passP.set(t.pos.x,BALL_R,t.pos.z)}if(this.offside(team,ti)){const ft=1-team;this.rules.restart(this,ft,"freekick",this.players[ti].pos.x*.95,this.players[ti].pos.z*.95,1.1);this.ui.note("Offside");return false}
    let dx=this.passP.x-p.pos.x,dz=this.passP.z-p.pos.z,dist=Math.hypot(dx,dz);if(dist<.001)return false;dx/=dist;dz/=dist;const r=p.ratings,pr=this.diff,pe=(100-r.pass)*.0025+(isAI?pr.passError*.6:.02),er=this.rng.z(pe),cs=Math.cos(er),sn=Math.sin(er),px=dx*cs-dz*sn,pz=dx*sn+dz*cs;let pow=this.tune.passPower,l=.15;if(type==="through"){pow=this.tune.throughPower;l=.2}else if(type==="lob"){pow=this.tune.lobPower;l=5.2}pow*=clamp(.75+r.pass*.0033,.7,1.15);pow*=clamp(.65+dist/30,.7,1.15);this.ball.owner=-1;this.ball.vel.x=px*pow;this.ball.vel.z=pz*pow;this.ball.vel.y=l;this.ball.spin.set(0,type==="lob"?2.1:.45,0);this.ball.lastT=team;this.ball.lastP=i;this.possT=-1;this.possP=-1;this.passI=ti;this.audio.kick(type==="lob"?1.1:.84);return true}
  shot(i,ch,fin,chip,isAI=false){if(!this.canKick(i))return false;const p=this.players[i],team=p.team,gx=this.adir(team)>0?PITCH_L*.5+.8:-PITCH_L*.5-.8;let gz=clamp(this.aim*GOAL_W*.5,-GOAL_W*.46,GOAL_W*.46);const r=p.ratings,pr=this.diff,es=(100-r.shot)*.004+(isAI?pr.shotError*.45:0);gz+=this.rng.z(es*8);let dx=gx-p.pos.x,dz=gz-p.pos.z,dist=Math.hypot(dx,dz);dx/=dist;dz/=dist;let pow=this.tune.shotPower*clamp(.45+ch*.85,.45,1.35);pow*=clamp(.78+r.shot*.0038,.7,1.2);let lift=chip?this.tune.chipLift:this.tune.shotLift;if(fin)lift*=.86;if(chip)pow*=.82;this.ball.owner=-1;this.ball.vel.x=dx*pow;this.ball.vel.z=dz*pow;this.ball.vel.y=lift+ch*1.6;this.ball.spin.set(0,fin?this.tune.magnus*2300:.8,0);this.ball.lastT=team;this.ball.lastP=i;this.possT=-1;this.possP=-1;this.passI=-1;this.audio.kick(1.1);return true}
  tackle(i,slide){const p=this.players[i];if(slide){p.slide=.36;p.vel.x+=Math.sin(p.facing)*3.2;p.vel.z+=Math.cos(p.facing)*3.2}const e=1-p.team;let hit=-1,b=2;for(let j=e*TEAM_N;j<e*TEAM_N+TEAM_N;j++){const q=this.players[j],d=Math.hypot(q.pos.x-p.pos.x,q.pos.z-p.pos.z);if(d<b){b=d;hit=j}}if(hit<0)return false;const q=this.players[hit],ch=clamp(.35+(p.ratings.tackle-q.ratings.dribble)*.005+(slide?.12:0),.15,.85),ok=this.rng.next()<ch;if(ok){if(this.ball.owner===hit||Math.hypot(this.ball.pos.x-q.pos.x,this.ball.pos.z-q.pos.z)<1.2){this.ball.owner=i;this.ball.vel.set(0,0,0);this.ball.lastT=p.team;this.ball.lastP=i;this.possT=p.team;this.possP=i;this.ui.note("Won tackle")}return true}if(slide&&this.settings.fouls){const ft=1-p.team;this.rules.restart(this,ft,"freekick",q.pos.x,q.pos.z,1.1);this.ui.note("Foul")}return false}
  human(dt){for(const p of this.players){p.ix=0;p.iz=0;p.spr=false}const s=this.players[this.selI],cy=this.scene.y(),mx=this.input.mx,mz=this.input.mz;let wx=mx*Math.cos(cy)-mz*Math.sin(cy),wz=-mz*Math.cos(cy)-mx*Math.sin(cy),l=wx*wx+wz*wz;if(l>1){const i=1/Math.sqrt(l);wx*=i;wz*=i}s.ix=wx;s.iz=wz;s.spr=this.input.d("sprint");s.ai="human";this.aim=clamp(this.aim+this.input.cYaw()*.8,-1,1);this.input.cPitch();this.aim*=.992;
    if(this.input.p("switchPlayer"))this.sw();if(this.input.p("pass"))this.pass(this.selI,"pass",-1,false);if(this.input.p("through"))this.pass(this.selI,"through",-1,false);if(this.input.p("lob"))this.pass(this.selI,"lob",-1,false);if(this.input.p("tackle"))this.tackle(this.selI,false);if(this.input.p("slide"))this.tackle(this.selI,true);
    if(this.input.d("shoot")){this.charging=true;this.charge=clamp(this.charge+dt,0,1.3);this.chargeN=sat(this.charge/1.3)}else if(this.charging&&this.input.r("shoot")){this.shot(this.selI,this.chargeN,this.input.d("finesse"),this.input.d("chip"),false);this.charging=false;this.charge=0;this.chargeN=0}else if(!this.input.d("shoot")){this.charging=false;this.charge=0;this.chargeN=0}
  }
  hotkeys(){if(this.input.p("toggleDebug")){this.settings.debugOverlay=!this.settings.debugOverlay;saveSet(this.settings);this.ui.dbg(this.settings.debugOverlay)}if(this.input.p("toggleTutorial")){this.ui.e.tutorial.style.display==="flex"?this.ui.closeTut():this.ui.openTut()}if(this.input.p("toggleDevPanel")){this.devOn=!this.devOn;this.ui.dev(this.devOn)}if(this.input.p("toggleCamera")){this.settings.cameraMode=this.settings.cameraMode==="broadcast"?"chase":"broadcast";saveSet(this.settings);this.ui.pullIn()}if(this.input.p("pointerLock")){this.input.pl?this.input.relPL():this.input.reqPL()}if(this.input.p("slowMo")){this.slow=!this.slow;this.ui.note(this.slow?"Slow motion 0.5x":"Slow motion off")}if(this.input.p("resetBall")&&this.settings.debugOverlay){this.ball.pos.set(0,BALL_R,0);this.ball.vel.set(0,0,0);this.ball.owner=-1;this.ui.note("Ball reset")}if(this.input.p("pause")){if(!this.active)return;this.rules.state==="paused"?this.rules.resume(this):this.rules.pause(this)}}
  restarts(dt){if(this.rules.state!=="restart"&&this.rules.state!=="kickoff")return;const t=this.rules.state==="kickoff"?this.rules.kick:this.rules.rTeam;if(t===0){this.selI=this.nearBall(0,true);if(this.input.p("pass"))this.pass(this.selI,"pass",-1,false);if(this.input.p("through"))this.pass(this.selI,"through",-1,false);if(this.input.p("lob"))this.pass(this.selI,"lob",-1,false);if(this.input.p("shoot"))this.shot(this.selI,.45,false,false,false)}else if(this.rules.t<.35){const p=this.nearBall(t,true);if(p>=0)this.pass(p,"pass",-1,true)}}
  sim(dt){if(!this.active)return;if(["paused","menu","fulltime"].includes(this.rules.state))return;if(this.rules.state==="replay"){const done=this.replay.update(this,dt);if(done){this.rules.state="kickoff";this.rules.t=1.15;this.reset(this.rules.kick);this.ball.pos.set(0,BALL_R,0);this.ball.vel.set(0,0,0);this.ball.owner=this.kPlayer(this.rules.kick);this.possT=this.rules.kick;this.audio.whistle(false)}return}
    this.human(dt);this.ai.upd(this,dt);this.restarts(dt);this.phys.step(this,dt);this.rules.upd(this,dt);if(this.rules.state==="live"){this.replay.rec(dt,this);if(this.ball.owner>=0&&this.players[this.ball.owner].team===0)this.selI=this.ball.owner;else if(this.possT!==0&&this.ball.owner<0)this.selI=this.nearBall(0,false)}}
  render(dt){this.audio.crowd(clamp((Math.abs(this.ball.pos.x)-26)/50,0,1));this.audio.update();this.scene.render(dt);this.ui.upd(dt)}
  loop(n){if(!this.runFlag)return;const s=n*1e-3;let dt=s-this.last;this.last=s;if(dt>.25)dt=.25;this.input.update();this.hotkeys();const ss=this.slow?.5:1;this.acc+=dt*ss;if(this.acc>MAX_ACC)this.acc=MAX_ACC;let st=0;while(this.acc>=this.fix&&st<MAX_STEPS){this.sim(this.fix);this.clock+=this.fix;this.acc-=this.fix;st++}this.render(dt);requestAnimationFrame(t=>this.loop(t))}
  run(){this.ui.menu(true);requestAnimationFrame(t=>{this.last=t*1e-3;this.loop(t)})}
}

const game=new Game();game.run();
</script>

<!--
QA Checklist
- [ ] One-file HTML runs with CDN module import and no build step.
- [ ] Main menu appears on launch.
- [ ] Start Match triggers kickoff state.
- [ ] Training mode starts with no AI pressure.
- [ ] WASD movement works.
- [ ] Sprint drains stamina.
- [ ] Ground pass (LMB/J) works.
- [ ] Through pass (E) works.
- [ ] Lob pass (Q) works.
- [ ] Shoot charge/release (RMB/K) works.
- [ ] Finesse modifier (F) changes shot behavior.
- [ ] Chip modifier (X) changes shot loft.
- [ ] Tackle (Space) works.
- [ ] Slide tackle (C) works.
- [ ] Player switch (Tab) works.
- [ ] Pause (Esc) opens pause menu.
- [ ] Camera toggle (V) switches modes.
- [ ] Pointer lock toggle (P) works.
- [ ] Debug overlay toggle (F3) works.
- [ ] Dev panel toggle (F4) works.
- [ ] Slow motion toggle (T) works.
- [ ] Debug ball reset (R) works only in debug mode.
- [ ] Goal detection increments score.
- [ ] Throw-in on sideline out-of-bounds.
- [ ] Goal kick/corner on endline out-of-bounds.
- [ ] Halftime swaps sides.
- [ ] Full-time state ends match.
- [ ] Replay plays after goal and returns to kickoff.
- [ ] Minimap updates ball + all players.
- [ ] Selected player ring follows controlled player.
- [ ] Stamina bar updates in HUD.
- [ ] Control remaps persist in localStorage.
- [ ] Settings persist in localStorage.
- [ ] Accessibility toggles update presentation.
- [ ] Audio starts only after user gesture.
- [ ] Whistle plays on match phase changes.
- [ ] Crowd/kick/UI sounds are audible.
- [ ] Quality setting changes renderer pixel ratio.
- [ ] Resize keeps scene/HUD usable on desktop/mobile.
- [ ] No copyrighted FIFA/EA assets/branding used.
-->
</body>
</html>
