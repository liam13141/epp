# weather_app.epp
# Run: python epp_runner.py weather_app.epp

set app to call flask_app with "E++ Weather"

define weather_page
  set html to ""
  set html to html + "<!doctype html><html lang='en'><head>"
  set html to html + "<meta charset='utf-8'/>"
  set html to html + "<meta name='viewport' content='width=device-width,initial-scale=1'/>"
  set html to html + "<title>Weather â€¢ E++</title>"

  set html to html + "<style>"
  set html to html + ":root{--bg1:#071225;--bg2:#0c2d3f;--card:rgba(255,255,255,.08);--border:rgba(255,255,255,.14);--txt:#eaf2ff;--mut:rgba(234,242,255,.78)}"
  set html to html + "body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:radial-gradient(1200px 600px at 20% 10%,#1d4ed8 0%,transparent 55%),radial-gradient(900px 500px at 80% 20%,#06b6d4 0%,transparent 60%),linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--txt)}"
  set html to html + ".wrap{max-width:1050px;margin:0 auto;padding:26px}"
  set html to html + ".glass{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:18px;backdrop-filter:blur(12px)}"
  set html to html + ".row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}"
  set html to html + "h1{margin:0;font-size:34px;line-height:1.1}"
  set html to html + ".sub{color:var(--mut);margin:8px 0 0 0}"
  set html to html + ".search{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}"
  set html to html + "input{flex:1;min-width:240px;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--txt);outline:none}"
  set html to html + "button{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.12);color:var(--txt);cursor:pointer}"
  set html to html + "button:hover{background:rgba(255,255,255,.18)}"
  set html to html + ".pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.16);color:var(--mut)}"
  set html to html + ".now{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-top:12px}"
  set html to html + ".big{font-size:56px;margin:0}"
  set html to html + ".mut{color:var(--mut)}"
  set html to html + ".grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}"
  set html to html + ".tile{background:rgba(0,0,0,.14);border:1px solid var(--border);border-radius:18px;padding:12px}"
  set html to html + ".tile b{color:var(--txt)}"
  set html to html + ".days{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px;margin-top:12px}"
  set html to html + ".day{background:rgba(0,0,0,.14);border:1px solid var(--border);border-radius:18px;padding:12px}"
  set html to html + ".d-top{display:flex;align-items:center;justify-content:space-between;gap:10px}"
  set html to html + ".d-date{font-weight:900}"
  set html to html + ".d-ico{font-size:26px}"
  set html to html + ".d-desc{color:var(--mut);margin-top:6px}"
  set html to html + ".d-row{color:var(--mut);margin-top:8px}"
  set html to html + ".msg{margin-top:12px;padding:12px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,.12)}"
  set html to html + ".err{border-color:rgba(255,120,120,.35);background:rgba(255,120,120,.10)}"
  set html to html + ".ok{border-color:rgba(120,255,200,.25);background:rgba(120,255,200,.08)}"
  set html to html + ".foot{color:rgba(234,242,255,.6);font-size:12px;margin-top:14px}"
  set html to html + "</style>"

  set html to html + "</head><body><div class='wrap'>"

  set html to html + "<div class='glass'>"
  set html to html + "<div class='row' style='justify-content:space-between'>"
  set html to html + "<div><h1>ğŸŒ¦ï¸ Weather</h1><p class='sub'>Search a city â†’ current + 7-day forecast with emojis, icons, and details.</p></div>"
  set html to html + "<div class='row'>"
  set html to html + "<span class='pill'>ğŸŒ¡ï¸ Units: <b id='unitLabel'>Â°F</b></span>"
  set html to html + "<button id='unitBtn' type='button'>Toggle Â°F / Â°C</button>"
  set html to html + "</div></div>"

  set html to html + "<form class='search' id='searchForm'>"
  set html to html + "<input id='cityInput' placeholder='Type a city (Miami, London, Tokyo...)' autocomplete='off'/>"
  set html to html + "<button type='submit'>ğŸ” Search</button>"
  set html to html + "<button id='geoBtn' type='button'>ğŸ“ Use my location</button>"
  set html to html + "</form>"

  set html to html + "<div id='status' class='msg ok' style='display:none'></div>"
  set html to html + "<div id='error' class='msg err' style='display:none'></div>"
  set html to html + "</div>"

  set html to html + "<div class='glass' style='margin-top:14px'>"
  set html to html + "<div class='row' style='justify-content:space-between;align-items:flex-start'>"
  set html to html + "<div><div style='font-size:18px;font-weight:900'>ğŸ“ <span id='place'>â€”</span></div>"
  set html to html + "<div class='mut'>ğŸ•’ <span id='time'>â€”</span></div></div>"
  set html to html + "<div class='mut'>Data: Open-Meteo (no key)</div>"
  set html to html + "</div>"

  set html to html + "<div class='now'>"
  set html to html + "<div>"
  set html to html + "<div style='font-size:28px;font-weight:900' id='nowDesc'>â€”</div>"
  set html to html + "<p class='big' id='nowTemp'>â€”</p>"
  set html to html + "<div class='row' style='gap:8px;flex-wrap:wrap'>"
  set html to html + "<span class='pill'>ğŸŒ¡ï¸ Feels <b id='feels'>â€”</b></span>"
  set html to html + "<span class='pill'>ğŸ’§ Humidity <b id='hum'>â€”</b></span>"
  set html to html + "<span class='pill'>ğŸ’¨ Wind <b id='wind'>â€”</b></span>"
  set html to html + "<span class='pill'>ğŸ§­ Dir <b id='wdir'>â€”</b></span>"
  set html to html + "<span class='pill'>ğŸŒ§ï¸ Precip <b id='precip'>â€”</b></span>"
  set html to html + "<span class='pill'>â˜ï¸ Clouds <b id='clouds'>â€”</b></span>"
  set html to html + "<span class='pill'>ğŸ“ˆ Pressure <b id='press'>â€”</b></span>"
  set html to html + "</div></div>"

  set html to html + "<div class='grid' style='min-width:280px'>"
  set html to html + "<div class='tile'>ğŸ”¢ Code<br><b id='code'>â€”</b><div class='mut' id='codeText'>â€”</div></div>"
  set html to html + "<div class='tile'>ğŸŒ… Sunrise<br><b id='sunrise'>â€”</b></div>"
  set html to html + "<div class='tile'>ğŸŒ‡ Sunset<br><b id='sunset'>â€”</b></div>"
  set html to html + "<div class='tile'>ğŸ§´ UV Max<br><b id='uv'>â€”</b></div>"
  set html to html + "</div>"
  set html to html + "</div></div>"

  set html to html + "<div class='glass' style='margin-top:14px'>"
  set html to html + "<div style='font-size:18px;font-weight:900'>ğŸ“† Next 7 Days</div>"
  set html to html + "<div id='days' class='days'></div>"
  set html to html + "<div class='foot'>Tip: try â€œMatoacaâ€, â€œNew Yorkâ€, or â€œLos Angelesâ€.</div>"
  set html to html + "</div>"

  set html to html + "</div>"

  set html to html + "<script>"
  set html to html + "let unit='fahrenheit'; let windUnit='mph'; let precipUnit='inch';"
  set html to html + "const $=(s)=>document.querySelector(s);"
  set html to html + "const show=(id,msg)=>{const el=$(id); el.style.display='block'; el.textContent=msg;};"
  set html to html + "const hideMsgs=()=>{ $('#status').style.display='none'; $('#error').style.display='none'; };"

  set html to html + "const emoji=(c)=>{"
  set html to html + "if(c===0) return 'â˜€ï¸'; if(c===1) return 'ğŸŒ¤ï¸'; if(c===2) return 'â›…'; if(c===3) return 'â˜ï¸';"
  set html to html + "if(c===45||c===48) return 'ğŸŒ«ï¸'; if(c>=51&&c<=57) return 'ğŸŒ¦ï¸'; if(c>=61&&c<=67) return 'ğŸŒ§ï¸';"
  set html to html + "if(c>=71&&c<=77) return 'ğŸŒ¨ï¸'; if(c>=80&&c<=82) return 'ğŸŒ¦ï¸'; if(c===85||c===86) return 'ğŸŒ¨ï¸';"
  set html to html + "if(c===95) return 'â›ˆï¸'; if(c===96||c===99) return 'â›ˆï¸ğŸ§Š'; return 'â“'; };"

  set html to html + "const desc=(c)=>{"
  set html to html + "if(c===0) return 'Clear sky'; if(c===1) return 'Mainly clear'; if(c===2) return 'Partly cloudy'; if(c===3) return 'Overcast';"
  set html to html + "if(c===45) return 'Fog'; if(c===48) return 'Rime fog'; if(c>=51&&c<=57) return 'Drizzle'; if(c>=61&&c<=67) return 'Rain';"
  set html to html + "if(c>=71&&c<=77) return 'Snow'; if(c>=80&&c<=82) return 'Showers'; if(c===85||c===86) return 'Snow showers';"
  set html to html + "if(c===95) return 'Thunderstorm'; if(c===96||c===99) return 'Thunderstorm + hail'; return 'Unknown'; };"

  set html to html + "const windDir=(deg)=>{"
  set html to html + "if(deg==null) return '-';"
  set html to html + "const dirs=['N','NE','E','SE','S','SW','W','NW'];"
  set html to html + "return dirs[Math.round(deg/45)%8]+' '+Math.round(deg)+'Â°'; };"

  set html to html + "async function geocode(city){"
  set html to html + "const url='https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(city)+'&count=1&language=en&format=json';"
  set html to html + "const r=await fetch(url); if(!r.ok) throw new Error('Geocoding failed');"
  set html to html + "const j=await r.json(); if(!j.results||!j.results.length) throw new Error('City not found');"
  set html to html + "return j.results[0]; }"

  set html to html + "async function forecast(lat,lon){"
  set html to html + "const url='https://api.open-meteo.com/v1/forecast'"
  set html to html + "+'?latitude='+lat+'&longitude='+lon"
  set html to html + "+'&temperature_unit='+unit"
  set html to html + "+'&wind_speed_unit='+windUnit"
  set html to html + "+'&precipitation_unit='+precipUnit"
  set html to html + "+'&timezone=auto'"
  set html to html + "+'&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation,cloud_cover,pressure_msl'"
  set html to html + "+'&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,uv_index_max,wind_speed_10m_max,sunrise,sunset'"
  set html to html + "+'&forecast_days=7';"
  set html to html + "const r=await fetch(url); if(!r.ok) throw new Error('Forecast failed'); return await r.json(); }"

  set html to html + "function render(place,data){"
  set html to html + "const u=(unit==='fahrenheit')?'Â°F':'Â°C';"
  set html to html + "$('#place').textContent=place.name+', '+(place.admin1?place.admin1+', ':'')+place.country;"
  set html to html + "$('#time').textContent=data.current.time+' â€¢ '+data.timezone;"
  set html to html + "const c=data.current;"
  set html to html + "$('#nowDesc').textContent=emoji(c.weather_code)+' '+desc(c.weather_code);"
  set html to html + "$('#nowTemp').textContent=Math.round(c.temperature_2m)+u;"
  set html to html + "$('#feels').textContent=Math.round(c.apparent_temperature)+u;"
  set html to html + "$('#hum').textContent=Math.round(c.relative_humidity_2m)+'%';"
  set html to html + "$('#wind').textContent=Math.round(c.wind_speed_10m)+' '+windUnit;"
  set html to html + "$('#wdir').textContent=windDir(c.wind_direction_10m);"
  set html to html + "$('#precip').textContent=(c.precipitation??0)+' '+precipUnit;"
  set html to html + "$('#clouds').textContent=(c.cloud_cover??0)+'%';"
  set html to html + "$('#press').textContent=(c.pressure_msl??'-')+' hPa';"
  set html to html + "$('#code').textContent=c.weather_code;"
  set html to html + "$('#codeText').textContent=desc(c.weather_code);"

  set html to html + "const d=data.daily;"
  set html to html + "$('#sunrise').textContent=d.sunrise[0]||'-';"
  set html to html + "$('#sunset').textContent=d.sunset[0]||'-';"
  set html to html + "$('#uv').textContent=(d.uv_index_max[0]??'-');"

  set html to html + "const daysEl=$('#days'); daysEl.innerHTML='';"
  set html to html + "for(let i=0;i<d.time.length;i++){"
  set html to html + "const card=document.createElement('div'); card.className='day';"
  set html to html + "const code=d.weather_code[i];"
  set html to html + "const hi=Math.round(d.temperature_2m_max[i]); const lo=Math.round(d.temperature_2m_min[i]);"
  set html to html + "const pop=(d.precipitation_probability_max[i]??0);"
  set html to html + "const wmx=Math.round(d.wind_speed_10m_max[i]??0);"
  set html to html + "const uvx=(d.uv_index_max[i]??'-');"
  set html to html + "card.innerHTML="
  set html to html + "  \"<div class='d-top'><div class='d-date'>\"+d.time[i]+\"</div><div class='d-ico'>\"+emoji(code)+\"</div></div>\""
  set html to html + " +\"<div class='d-desc'>\"+desc(code)+\"</div>\""
  set html to html + " +\"<div class='d-row'>ğŸ”º \"+hi+u+\" &nbsp; ğŸ”» \"+lo+u+\"</div>\""
  set html to html + " +\"<div class='d-row'>ğŸŒ§ï¸ Rain chance: \"+pop+\"%</div>\""
  set html to html + " +\"<div class='d-row'>ğŸ’¨ Wind max: \"+wmx+\" \"+windUnit+\" &nbsp; ğŸ§´ UV max: \"+uvx+\"</div>\""
  set html to html + " +\"<div class='d-row'>ğŸŒ… \"+(d.sunrise[i]||'-')+\"<br>ğŸŒ‡ \"+(d.sunset[i]||'-')+\"</div>\";"
  set html to html + "daysEl.appendChild(card); }"
  set html to html + "}"

  set html to html + "async function loadCity(city){"
  set html to html + "hideMsgs();"
  set html to html + "if(!city||!city.trim()){ show('#error','Type a city name first.'); return; }"
  set html to html + "show('#status','Loading '+city+'â€¦');"
  set html to html + "try{"
  set html to html + "const place=await geocode(city.trim());"
  set html to html + "const data=await forecast(place.latitude,place.longitude);"
  set html to html + "render(place,data);"
  set html to html + "show('#status','âœ… Loaded: '+place.name+', '+place.country);"
  set html to html + "}catch(e){ show('#error','âš ï¸ '+e.message); } }"

  set html to html + "async function loadGeo(){"
  set html to html + "hideMsgs();"
  set html to html + "if(!navigator.geolocation){ show('#error','Geolocation not supported.'); return; }"
  set html to html + "show('#status','Requesting locationâ€¦');"
  set html to html + "navigator.geolocation.getCurrentPosition(async (pos)=>{"
  set html to html + "try{"
  set html to html + "const data=await forecast(pos.coords.latitude,pos.coords.longitude);"
  set html to html + "render({name:'Your location',admin1:'',country:''},data);"
  set html to html + "show('#status','âœ… Loaded your location');"
  set html to html + "}catch(e){ show('#error','âš ï¸ '+e.message); }"
  set html to html + "}, ()=> show('#error','Location permission denied.')); }"

  set html to html + "document.getElementById('searchForm').addEventListener('submit',(ev)=>{ev.preventDefault(); loadCity(document.getElementById('cityInput').value);});"
  set html to html + "document.getElementById('geoBtn').addEventListener('click', loadGeo);"
  set html to html + "document.getElementById('unitBtn').addEventListener('click', ()=>{"
  set html to html + "unit=(unit==='fahrenheit')?'celsius':'fahrenheit';"
  set html to html + "windUnit=(unit==='fahrenheit')?'mph':'kmh';"
  set html to html + "precipUnit=(unit==='fahrenheit')?'inch':'mm';"
  set html to html + "document.getElementById('unitLabel').textContent=(unit==='fahrenheit')?'Â°F':'Â°C';"
  set html to html + "const city=document.getElementById('cityInput').value; if(city&&city.trim()) loadCity(city);"
  set html to html + "});"

  set html to html + "loadCity('New York');"
  set html to html + "</script>"

  set html to html + "</body></html>"

  return call flask_html with html
end define

call flask_get with app, "/weather", weather_page
call flask_get with app, "/", "Go to /weather"

call flask_run with app, "127.0.0.1", 5000